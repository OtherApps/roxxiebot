
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>RoxxieBot – Stars Overlay (Christmas)</title>
	<link rel="stylesheet" type="text/css" href="obscss.css">
<style>

</style>
<script>
<!--
const months = [
  "January", "February", "March", "April", "May", "June",
  "July", "August", "September", "October", "November", "December"
];
const date = new Date();


var fixurl,serverURL;
	const queryString = window.location.search;
	const urlParams = new URLSearchParams(queryString); 
	var twitchUser=urlParams.get("TwitchId")??"RoxxieToxxic";
	var tsoh =  urlParams.get("streamer")??"RoxxieToxxic";
	
var checkname= months[date.getMonth()]+"_"+tsoh+"_vipboard2.json";


console.log(checkname);
if(window.location.hostname !="roxxiebot.ngrok.app")
{
serverURL= "http://192.168.1.172:8080/"
fixurl = "http://192.168.1.172:8080/raw?url=";
}
else{
serverURL= "https://roxxiebot.ngrok.app/"; 
fixurl= "https://roxxiebot.ngrok.app/raw?url="; 
}
//-->
</script>
<script src="https://cdn.jsdelivr.net/npm/comfy.js@latest/dist/comfy.min.js"></script>
<script src="YnChatOnline.js"></script>
<script src="must.js"></script>

</head>
<body >
<div>

</div>
<div class="snow"></div>
<div class="overlay-wrapper">
  <div class="board" id="scoreboard" style="display:none">
    <div class="board-header" >
      <div class="title" style="200px;text-align:center;">
	  
        ⭐Top Stars⭐
		
      </div>
     
    </div>
    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>User</th>
          <th style="text-align:right;">Stars</th>
        </tr>
      </thead>
      <tbody id="leaderboard-body"></tbody>
    </table>
  </div>
</div>

<script>

let viewers = [];
const doubleStars=false;

function fadeOut(element) {
    // Start opacity at its current computed value or 1 if not set
    let opacity = parseFloat(window.getComputedStyle(element).opacity) || 1;

    const interval = setInterval(function() {
        if (opacity <= 0.1) {
            clearInterval(interval); // Stop the interval
            element.style.display = 'none'; // Hide the element completely from layout
        } else {
            opacity -= 0.05; // Decrease opacity by a small step
            element.style.opacity = opacity;
        }
    }, 50); // The '50' defines the speed/smoothness of the animation
}

function fadeIn(element) {
    let opacity = 0;
    element.style.opacity = 0;
    element.style.visibility = 'visible'; // Make it visible first so opacity can be seen

    const interval = setInterval(function() {
        if (opacity >= 1) {
            clearInterval(interval); // Stop the interval when fully faded in
        } else {
            opacity += 0.05; // Increment opacity
            element.style.opacity = opacity;
        }
    }, 50); // Adjust timing and increment for desired speed
}

async function loadJson(){
	  try {
        const response = await fetch(serverURL+checkname);
        const data = await response.text();
		//console.log(data);
		
		loadViewers(data);
	  
    } catch (error) {
        console.error('Error fetching data:', error);
    }

}


async function makeItVisible(){


var divScore = document.getElementById("scoreboard");
divScore.style.display="inline-block";
fadeIn(divScore);

 await delay(8000); // Wait for 5 minutes
 fadeOut(divScore)
//divScore.style.display="none";
//console.log("hidden now");

}
function delay(ms) {
  return new Promise(resolve => setTimeout(resolve, ms));
}


//setInterval(makeItVisible, 100000)
// Load from same localStorage key as Christmas dashboard
function loadViewers(data) {
  const raw = data;
  if (!raw) { viewers = []; return; }
  try { viewers = JSON.parse(raw) || []; } catch(e) { viewers = []; }
  viewers.forEach(v => { if (typeof v.stars === "undefined") v.stars = 0; });
  renderLeaderboard();
}

function aggregated() {
  const map = {};
	
	var temp = null; 
	var listofnames=""; 
  
  viewers.forEach(v => {
    const key = v.username.toLowerCase();
  if (!map[key]) map[key] = { key, username: v.username, stars:0};
	if(listofnames.includes(v.username))
	{
		map[key].stars = parseInt(v.stars) +parseInt(map[key].stars);
		}
	else
	{
		listofnames=listofnames +","+v.username; 
		map[key].stars = v.stars;
		}
  //map[key].stars = v.stars;
  });
  return Object.values(map);
}

function renderLeaderboard() {
//console.log(viewers);

  const tbody = document.getElementById("leaderboard-body");
  const oldRows = Array.from(tbody.querySelectorAll("tr[data-id]"));
  const oldPos = {};
  oldRows.forEach(r => oldPos[r.dataset.id] = r.getBoundingClientRect().top);

  const sorted = aggregated().sort((a,b)=>b.stars-a.stars).slice(0,10);

  const rowMap = {};
  oldRows.forEach(r=>rowMap[r.dataset.id]=r);

  tbody.innerHTML = "";
  sorted.forEach((u, i)=>{
    let row = rowMap[u.key];
    if (!row) {
      row = document.createElement("tr");
      row.dataset.id = u.key;
    } else {
      row.innerHTML = "";
    }
	//u.stars=parseInt(u.stars);
	//console.log(u.stars);
	
    row.innerHTML = `
      <td class="rank">${i+1}</td>
      <td class="user">${u.username}</td>
      <td class="stars">${u.stars}</td>
    `;
    tbody.appendChild(row);
  });

  const newRows = Array.from(tbody.querySelectorAll("tr[data-id]"));
  newRows.forEach(row=>{
    const id=row.dataset.id;
    if (oldPos[id]!=null){
      const newY=row.getBoundingClientRect().top;
      const delta=oldPos[id]-newY;
      if (Math.abs(delta)>2){
        row.style.transform = "translateY(" + delta + "px)";
        row.classList.add("moved");
        requestAnimationFrame(()=> row.style.transform = "" );
      }
    }
  });
}

// Initial load + polling refresh
loadJson()


function beginFun(TwitchChannel){
console.log("Currently working on " + TwitchChannel);

	ComfyJS.onResub=(user, message, subtier, months, cumulativeMonths, streakMonths, data) =>{
		console.log("Re-Sub");
			console.log(data);
			
			const viewer = ensureViewer("Twitch-bot", user);
			
			addStars2 (viewer, 10,"twitch-bot",1)
			
			console.log(viewer);
			
	
		}
		/**/
		ComfyJS.onSub=( user, message, subTierInfo, extra )=>{
		console.log("new subs");
		console.log(extra);
		const viewer = ensureViewer("Twitch-bot", user);
		viewer.stars=parseInt(viewer.stars+10);
			addStars2 (viewer, 10,"twitch-bot",1)
		console.log(viewer);
		
		};
		
		ComfyJS.onSubGift=( gifterUser, streakMonths, recipientUser, senderCount, subTierInfo, extra ) =>{
			
		}
		
		ComfyJS.onSubMysteryGift =( gifterUser, numbOfSubs, senderCount, subTierInfo, extra ) =>{
			console.log("Has gifted: " + numbOfSubs); 
			
		
			const viewer = ensureViewer("Twitch-bot", gifterUser);
			
			viewer.stars = parseInt(viewer.stars+ (numbOfSubs*10));
			console.log(viewer);	
				addStars2 (viewer, numbOfSubs*10,"twitch-bot",numbOfSubs)
			//SubIt(gifterUser + " gifted  " +numbOfSubs + " subs " ); 
			//Fix this  above
		}
		
	ComfyJS.onCommand = (user, command, message, flags, extra) => {
	
	
	if(flags.mod || flags.broadcaster){
	if(command==="vip"){
	makeItVisible();
	
	}
	else if (command==="add"){
	var data = message.split(" ");
	var twitchMod=user+"Twitch-Mod";
	
	console.log(data)
	const viewer = ensureViewer("Twitch-mod", data[0]);
	addStars2 (viewer, data[1],twitchMod,data[2])


	}
  } 
  
	}
ComfyJS.onChat = ( user, message, flags, self, extra ) => {
 //console.log( extra);
 
}

        ComfyJS.Init(TwitchChannel);
  
}
beginFun(twitchUser)

</script>


</body>
</html>
